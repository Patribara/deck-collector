<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Deck Collector ‚Äì Mehrere Decks</title>
  <style>
    :root{
      --bg:#0b1020; --ink:#e9eef8; --muted:#9fb0cb; --accent:#7cf3d6; --accent-2:#8aa9ff; --danger:#ff6b6b;
      --card-w: 200px; --card-h: 280px; --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji; color:var(--ink); background:
      linear-gradient(180deg, rgba(9,14,32,.75), rgba(9,14,32,.75)),
      radial-gradient(1200px 800px at 70% -10%, #1a2250 0%, #0b1020 60%),
      url('img/bg-stars.jpg') center/cover fixed no-repeat;
    }
    a{color:var(--accent)}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px; padding:20px clamp(16px,3vw,28px); border-bottom:1px solid #1c2648; backdrop-filter:saturate(120%) blur(6px); position:sticky; top:0; background:linear-gradient(180deg, rgba(9,14,32,.7), rgba(9,14,32,.3)); z-index:5}
    .title{display:flex; gap:12px; align-items:center}
    .logo{width:36px; height:36px; border-radius:10px; background: conic-gradient(from 0deg, #7cf3d6, #8aa9ff, #f9b8ff, #7cf3d6); box-shadow:0 0 24px #7cf3d680 inset}
    .progress{opacity:.9}

    main{max-width:1200px; margin:24px auto; padding:0 clamp(12px,3vw,28px) 40px}

    /* === Deck-√úbersicht (Stacks) === */
    .deck-grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:18px}
    .deck{position:relative; border:1px solid #223169; background:linear-gradient(180deg,#121a3a,#0d1431 60%, #0b1022); border-radius:18px; padding:18px; overflow:hidden; cursor:pointer; transition: transform .15s ease, box-shadow .15s ease}
    .deck:hover{transform: translateY(-2px); box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .deck .cover{height:160px; border:1px solid #29408b; border-radius:14px; background:radial-gradient(500px 240px at 60% 20%, rgba(124,243,214,.2), transparent 60%), linear-gradient(180deg,#0f183a,#0b1128); display:grid; place-items:center; font-size:42px; position:relative; overflow:hidden}
    .deck .cover img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter:saturate(105%) contrast(105%)}
    .deck .cover .veil{position:absolute; inset:0; background:linear-gradient(180deg, rgba(10,14,32,.35), rgba(10,14,32,.55))} 
    .deck .meta{display:flex; justify-content:space-between; margin-top:10px; color:var(--muted); font-size:13px}
    .pill{background:#132143; color:#b8c7ea; border:1px solid #223169; padding:4px 8px; border-radius:999px; font-size:12px}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap}

    /* === Kartenraster === */
    .grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(var(--card-w), 1fr)); gap:18px}
    .slot{position:relative; width:100%; aspect-ratio: 200/280; border-radius:var(--radius); border:1px solid #233166; background:linear-gradient(180deg,#0f1534 0%,#0b1022 100%); display:grid; place-items:center; overflow:hidden}
    .slot.locked::before{content:"LOCKED"; position:absolute; inset:auto 8px 8px auto; font-size:10px; letter-spacing:.16em; color:#6d7bb1; background:#132045; border:1px solid #1e2b57; padding:3px 6px; border-radius:6px}
    .slot.locked .shine{position:absolute; inset:0; background:linear-gradient(120deg, transparent 0 35%, rgba(255,255,255,.06) 45%, transparent 60%); transform:skewX(-12deg); animation: shine 3.6s linear infinite}
    @keyframes shine{0%{background-position:-120% 0}100%{background-position:120% 0}}

    .card{position:relative; width:calc(var(--card-w) * .92); height:calc(var(--card-h) * .92); border-radius:calc(var(--radius) + 4px); background:#0c0f22; border:1px solid #2a3777; box-shadow:0 20px 40px rgba(0,0,0,.35), 0 0 0 1px rgba(124,243,214,.08) inset; overflow:hidden; transform-style:preserve-3d; transition: box-shadow .2s ease}
    .card .inner{position:absolute; inset:8px; border-radius:14px; padding:10px; display:flex; flex-direction:column; gap:10px; background: linear-gradient(180deg,#121a3a 0%, #0d1431 40%, #0b1022 100%)}
    .name{font-weight:800; letter-spacing:.02em; font-size:14px}
    .illus{flex:1; border-radius:12px; background: radial-gradient(300px 180px at 60% 30%, #152358, #0c1536 60%); border:1px solid #223065; display:grid; place-items:center; overflow:hidden}
    .illus img{max-width:100%; max-height:100%; object-fit:cover; border-radius:10px}
    .meta{font-size:12px; color:var(--muted); display:flex; justify-content:space-between}

    /* Holo shimmer for special cards */
    .holo{position:relative; isolation:isolate}
    .holo::before{content:""; position:absolute; inset:0; border-radius:inherit; mix-blend-mode: screen; background:
      repeating-linear-gradient( 115deg, rgba(255,255,255,.08) 0 2px, transparent 2px 6px),
      linear-gradient(135deg, rgba(124,243,214,.25), rgba(138,169,255,.15) 40%, rgba(249,184,255,.25));
      opacity:.9; filter: saturate(160%);
      animation: holoShift 6s linear infinite; pointer-events:none; z-index:1}
    .holo::after{content:""; position:absolute; inset:-40%; background:
      radial-gradient(120px 80px at 30% 20%, rgba(255,255,255,.25), transparent 70%),
      radial-gradient(80px 60px at 70% 60%, rgba(255,255,255,.18), transparent 70%);
      mix-blend-mode:screen; animation: holoSpark 7.5s ease-in-out infinite}
    @keyframes holoShift{0%{background-position:0 0, 0 0} 100%{background-position:800px 0, 600px 0}}
    @keyframes holoSpark{0%,100%{transform:translateX(-5%) rotate(0.001deg)}50%{transform:translateX(5%)}}

    /* Overlay */
    .overlay{position:fixed; inset:0; display:none; place-items:center; z-index:50; background: radial-gradient(900px 600px at 50% 10%, rgba(12,17,40,.9), rgba(8,12,28,.95)), rgba(3,6,16,.6)}
    .overlay.active{display:grid}
    .stage{position:relative; width:min(760px, 92vw); height:min(520px, 74vh); display:grid; place-items:center}

    /* Enhanced chest */
    .chest{position:relative; width:380px; height:190px; background:linear-gradient(#7a4a1f, #6a3c14); border:2px solid #3a1f07; border-radius:10px; box-shadow:0 8px 40px rgba(0,0,0,.5) inset}
    .chest .band{position:absolute; inset:0; background:linear-gradient(90deg, transparent 0 44%, #b58b1a 44% 56%, transparent 56% 100%)}
    .lid{position:absolute; bottom:100%; left:0; width:100%; height:74px; background:linear-gradient(#7a4a1f, #6a3c14); border:2px solid #3a1f07; border-bottom:none; border-radius:10px 10px 0 0; transform-origin: bottom; transform:rotateX(0deg); box-shadow:0 8px 30px rgba(0,0,0,.45) inset}
    .chest.glow{box-shadow:0 0 24px rgba(252, 211, 77,.4), 0 8px 40px rgba(0,0,0,.5) inset}

    /* Rays + flash */
    .rays{position:absolute; width:520px; height:520px; border-radius:50%; background:
      conic-gradient(from 0deg, rgba(255,255,255,.18), transparent 30%, rgba(255,255,255,.18) 35%, transparent 65%),
      radial-gradient(closest-side, rgba(255,255,255,.18), transparent 70%);
      filter: blur(6px); opacity:0; pointer-events:none}
    .flash{position:absolute; width:280px; height:280px; border-radius:50%; background:radial-gradient(circle, rgba(255,255,255,.9), rgba(255,255,255,.0) 60%); opacity:0; pointer-events:none}

    .fly-card{position:absolute; width:var(--card-w); height:var(--card-h); border-radius:18px; border:1px solid #2a3777; overflow:hidden; opacity:0; transform:translateY(40px) scale(.9) rotate(6deg); cursor:grab}
    .fly-card:active{cursor:grabbing}
    .fly-card .inner{inset:10px}

    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid #2a3777; background:#0f1534; color:var(--ink); cursor:pointer}

    .toast{position:fixed; left:50%; bottom:22px; transform:translateX(-50%); background:#10183c; border:1px solid #2a3777; padding:10px 14px; border-radius:10px; display:none; z-index:60}
    .toast.show{display:block}

    .footer{opacity:.6; font-size:12px; margin-top:18px}

    /* Breadcrumbs */
    .crumbs{display:flex; gap:8px; align-items:center; margin:8px 0 18px}
    .crumbs a{color:#b8c7ea; text-decoration:none; border:1px solid #223169; padding:6px 10px; border-radius:10px}
      /* Cover-Lock Styles */
    .cover.locked{position:relative}
    .cover.locked img{filter: blur(10px) saturate(.6) contrast(.85) brightness(.85)}
    .cover .lock-badge{position:absolute; top:8px; right:8px; display:inline-flex; align-items:center; gap:6px; font-size:12px; background:rgba(8,12,28,.7); border:1px solid #233169; color:#c9d5f7; padding:6px 8px; border-radius:10px}
    .cover .lock-badge .i{width:16px; height:16px; display:grid; place-items:center; border-radius:50%; border:1px solid #2a3b7a; font-weight:700; font-size:11px}
    .cover .tooltip{position:absolute; top:36px; right:8px; background:#0f1838; color:#cfe0ff; border:1px solid #223169; padding:8px 10px; font-size:12px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.35); opacity:0; pointer-events:none; transform:translateY(-4px); transition:.15s ease}
    .cover .lock-badge:hover + .tooltip{opacity:1; transform:translateY(0)}
    .cover.unlocked img{filter:none}
    .cover.unlocked .veil{display:none}

    /* Download-Icon unten rechts auf freigeschaltetem Cover */
    .cover .dl-icon{position:absolute; right:10px; bottom:10px; z-index:3; display:inline-grid; place-items:center; width:38px; height:38px; border-radius:12px; background:rgba(12,18,42,.85); border:1px solid #223169; box-shadow:0 4px 12px rgba(0,0,0,.35); cursor:pointer; text-decoration:none}
    .cover .dl-icon:hover{transform:translateY(-1px)}
    .cover .dl-icon svg{width:20px; height:20px; fill:#cfe0ff; opacity:.95}

    /* Modal: Cover Unlocked */
    .modal{position:fixed; inset:0; display:none; place-items:center; z-index:70; background: radial-gradient(900px 600px at 50% 10%, rgba(12,17,40,.92), rgba(8,12,28,.97)), rgba(3,6,16,.6)}
    .modal.active{display:grid}
    .modal .box{width:min(760px,92vw); border:1px solid #223169; background:linear-gradient(180deg,#0e1432,#0a1026); border-radius:16px; padding:18px; color:#e6eeff}
    .modal .box header{display:flex; justify-content:space-between; align-items:center; border:none; padding:0; position:static; background:none}
    .modal .box .content{display:grid; gap:12px; margin-top:10px}
    .modal .preview{border:1px solid #223169; border-radius:12px; overflow:hidden; max-height:48vh}
    .modal .preview img{width:100%; height:auto; display:block}
  </style>
</head>
<body>
  <header>
    <div class="title">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div style="font-weight:800; letter-spacing:.02em">Deck Collector</div>
        <div class="progress" id="progress">0 Karten gesammelt</div>
      </div>
    </div>
    <div class="toolbar">
      <button class="btn" id="scanBtn">QR scannen (Kamera)</button>
      <button class="btn" id="shareBtn">Link kopieren</button>
      <button class="btn" id="resetBtn" title="Sammlung lokal l√∂schen">Zur√ºcksetzen</button>
    </div>
  </header>

  <main>
    <div id="view-decks">
      <h2>Deine Decks</h2>
      <div class="deck-grid" id="deckGrid"></div>
      <p class="footer">Tipp: Tippe auf einen Stapel, um sein Kartendeck zu √∂ffnen. QR-Codes funktionieren weiterhin deck√ºbergreifend.</p>
    </div>

    <div id="view-deck" style="display:none">
      <div class="crumbs"><a href="#" id="backToDecks">‚Üê Zur√ºck zu allen Decks</a><span class="pill" id="deckName"></span></div>
      <section class="grid" id="grid"></section>
    </div>
  </main>

  <!-- Manual Code Modal (fallback for QR scan) -->
  <div class="modal" id="manualScanModal" role="dialog" aria-modal="true" aria-labelledby="manualScanTitle" style="z-index:75;display:none;place-items:center;">
    <div class="box">
      <header>
        <h3 id="manualScanTitle" style="margin:0">Manuell freischalten</h3>
        <button class="btn" id="closeManualModal">Schlie√üen</button>
      </header>
      <div class="content" style="gap:10px">
        <label style="display:block">Code oder URL eingeben:</label>
        <input id="manualCodeInput" type="text" placeholder="z.B. 1501 oder https://...unlock=1501" style="width:100%; padding:10px; border-radius:10px; border:1px solid #223169; background:#0e1432; color:#e6eeff" />
        <div style="display:flex; gap:10px; justify-content:flex-end">
          <button class="btn" id="manualSubmitBtn">Freischalten</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cover-Unlocked Modal -->
  <div class="modal" id="coverModal" role="dialog" aria-modal="true" aria-labelledby="coverModalTitle">
    <div class="box">
      <header>
        <h3 id="coverModalTitle" style="margin:0">Your Cover Image is now unlocked üéâ</h3>
        <button class="btn" id="closeCoverModal">Schlie√üen</button>
      </header>
      <div class="content">
        <div class="preview"><img id="coverPreview" alt="Deck Cover Preview" /></div>
        
      </div>
    </div>
  </div>

  <!-- Lootbox Overlay -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="stage">
      <div class="rays" id="rays"></div>
      <div class="flash" id="flash"></div>
      <div class="chest" id="chest">
        <div class="band"></div>
        <div class="lid" id="lid"></div>
      </div>
      <div class="fly-card" id="flyCard">
        <div class="inner holo" id="flyInner">
          <div class="name" id="flyName">Karte</div>
          <div class="illus" id="flyIllus"></div>
          <div class="meta"><span id="flyMeta">Special</span><span id="flyId">Demo</span></div>
        </div>
      </div>
      <button class="btn" style="position:absolute; top:14px; right:14px" id="closeOverlay">Schlie√üen</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/***********************
 * DECKS & CARDS (mit Bildern)
 ***********************/
const DECKS = [
  {
    id: 'season1',
    name: 'Season 1',
    cover: 'S1',
    coverImg: 'img/CoverOXXO',
    cards: [
      {id:"c01", name:"Welcome to the Castle", img:"img/karte1.png",  special:false, code:"1501"},
      {id:"c02", name:"Date Night",           img:"img/karte2.png",  special:false, code:"1502"},
      {id:"c03", name:"Pyjama Party",         img:"img/karte3.png",  special:false, code:"1503"},
      {id:"c04", name:"Dance with me",        img:"img/karte4.png",  special:false, code:"1504"},
      {id:"c05", name:"Cancun Weather",       img:"img/karte5.png",  special:false, code:"1505"},
      {id:"c06", name:"I LOVE You",           img:"img/karte6.png",  special:false, code:"1506"},
      {id:"c07", name:"Happy Wife",           img:"img/karte7.png",  special:false, code:"1507"},
      {id:"c08", name:"Five Villages?",       img:"img/karte8.png",  special:false, code:"1508"},
      {id:"c09", name:"Matching Clothes",     img:"img/karte9.png",  special:false, code:"1509"},
      {id:"c10", name:"In the Heide",         img:"img/karte10.png", special:false, code:"1510"},
      {id:"c11", name:"Cat Love",             img:"img/karte11.png", special:false, code:"1511"},
      {id:"c12", name:"Gelato mi Amore",      img:"img/karte12.png", special:false, code:"1512"}
    ]
  },
  {
    id: 'mystery',
    name: 'MysteryHolo',
    cover: '‚ú®',
    coverImg: 'img/CoverYOURNAME',
    cards: [
      {id:"s01", name:"Wedding Dream", img:"img/holo1.png", special:true,  code:"HOLO1"},
      {id:"s02", name:"Taco Lover",    img:"img/holo2.png", special:true,  code:"HOLO2"},
      {id:"s03", name:"Japan Trip",    img:"img/holo3.png", special:true,  code:"HOLO3"}
    ]
  },
  {
    id: 'season2',
    name: 'Season 2',
    cover: 'S2',
    coverImg: 'img/CoverTravel',
    cards: [
      {id:"s2c01", name:"Northernlights",         img:"img/Travel1.png",  special:false, code:"S2-01"},
      {id:"s2c02", name:"Luchador Love",           img:"img/Travel2.png",  special:false, code:"S2-02"},
      {id:"s2c03", name:"The boy from the 8",      img:"img/Travel3.png",  special:false, code:"S2-03"},
      {id:"s2c04", name:"B√ºsum Night",             img:"img/Travel4.png",  special:false, code:"S2-04"},
      {id:"s2c05", name:"Vibing",                   img:"img/Travel5.png",  special:false, code:"S2-05"},
      {id:"s2c06", name:"Palacio de Correos",      img:"img/Travel6.png",  special:false, code:"S2-06"},
      {id:"s2c07", name:"Acapulco Tourist Look",   img:"img/Travel7.png",  special:false, code:"S2-07"},
      {id:"s2c08", name:"Ruka Snowboarding",        img:"img/Travel8.png",  special:false, code:"S2-08"},
      {id:"s2c09", name:"Mexican Goodbye",          img:"img/Travel9.png",  special:false, code:"S2-09"},
      {id:"s2c10", name:"Happy Birthday!!!",        img:"img/Travel10.png", special:false, code:"S2-10"}
    ]
  }
];

const STORAGE_KEY = "deck-collector-v2"; // v2 wegen neuer Struktur

/***********************
 * UTILITIES           *
 ***********************/
const qs = sel => document.querySelector(sel);
const el = (tag, cls) => {const n=document.createElement(tag); if(cls) n.className=cls; return n;}
const toast = (msg, ms=2400)=>{const t=qs('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), ms)};
const save = (ids)=> localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
const load = ()=> { try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') }catch{ return [] } };
const ALL_CARDS = DECKS.flatMap(d=> d.cards.map(c=> ({...c, deckId:d.id})) );
const COVER_SRC = {}; // deckId -> resolved cover URL (with extension)

let CURRENT_DECK = null; // deckId oder null (√úbersicht)

/***********************
 * DECK-√úBERSICHT      *
 ***********************/
function renderDecks(){
  CURRENT_DECK = null;
  qs('#view-decks').style.display='block';
  qs('#view-deck').style.display='none';

  const own = new Set(load());
  const deckGrid = qs('#deckGrid');
  deckGrid.innerHTML='';
  DECKS.forEach(deck=>{
    const total = deck.cards.length;
    const got = deck.cards.filter(c=> own.has(c.id)).length;
    const completed = got === total && total>0;

    const node = el('div','deck');
    const cover = el('div','cover');

    // helper to resolve cover path with extension fallbacks
    function resolveAndLoadCover(basePath, cb){
      const hasExt = /\.[a-zA-Z0-9]{3,4}$/.test(basePath||'');
      const candidates = hasExt ? [basePath] : [basePath+'.jpg', basePath+'.png', basePath+'.jpeg', basePath+'.webp'];
      let idx = 0; const img = new Image(); img.alt = deck.name;
      function tryNext(){ if(idx>=candidates.length){ cb(null); return; } img.src = candidates[idx++]; }
      img.onload = ()=> cb(img);
      img.onerror = tryNext;
      tryNext();
      return img;
    }

    if(deck.coverImg){
      const veil = el('div','veil');
      const img = resolveAndLoadCover(deck.coverImg, function(loaded){
        if(loaded){ COVER_SRC[deck.id] = loaded.src; }
        // if completed and cover successfully loaded, add download button now
        if(completed && COVER_SRC[deck.id]){
          cover.classList.add('unlocked');
          // Download-Icon unten rechts einf√ºgen
          const link = document.createElement('a');
          link.className = 'dl-icon';
          link.href = (COVER_SRC[deck.id] || '');
          // Dateiendung ermitteln f√ºr sch√∂nen Dateinamen (ohne Regex)
          var src = link.href;
          var dot = src.lastIndexOf('.') >= 0 ? src.lastIndexOf('.') : src.length;
          var ext = src.slice(dot);
          if(!ext || ext.length>5){ ext = '.jpg'; }
          var fname = (deck.name||'cover').trim().split(' ').join('_') + ext;
          link.setAttribute('download', fname);
          link.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3a1 1 0 0 1 1 1v8.586l2.293-2.293a1 1 0 1 1 1.414 1.414l-4.004 4.004a1 1 0 0 1-1.414 0L7.286 11.707a1 1 0 1 1 1.414-1.414L11 12.586V4a1 1 0 0 1 1-1Zm-7 14a1 1 0 0 1 1-1h12a1 1 0 1 1 0 2H6a1 1 0 0 1-1-1Z"/></svg>';
          link.addEventListener('click', (ev)=> ev.stopPropagation());
          cover.appendChild(link);
        }
      });
      cover.appendChild(img);
      cover.appendChild(veil);
    } else {
      cover.textContent = deck.cover;
    }

    // Lock / Unlock UI (blur + tooltip)
    if(deck.coverImg){
      if(!completed){
        cover.classList.add('locked');
        const badge = el('div','lock-badge');
        const dot = el('div','i'); dot.textContent='i'; badge.appendChild(dot);
        const txt = document.createElement('span'); txt.textContent = 'Cover locked'; badge.appendChild(txt);
        cover.appendChild(badge);
        const tip = el('div','tooltip'); tip.textContent = 'This Cover is still locked. Collect all Cards to Unlock it';
        cover.appendChild(tip);
      }
      // if completed but image not yet loaded, class will be toggled + button added in onload above
    }

    const h3 = document.createElement('h3'); h3.textContent = deck.name; h3.style.margin='12px 0 2px';
    const meta = el('div','meta'); meta.innerHTML = `<span>${got} / ${total} gesammelt</span><span class="pill">${deck.id}</span>`;
    node.append(cover, h3, meta);
    node.addEventListener('click', ()=> openDeck(deck.id));
    deckGrid.appendChild(node);
  });
  updateGlobalProgress();
}

function openDeck(deckId){
  CURRENT_DECK = deckId;
  const deck = DECKS.find(d=>d.id===deckId);
  qs('#deckName').textContent = deck.name;
  qs('#view-decks').style.display='none';
  qs('#view-deck').style.display='block';
  renderGrid(deckId);
}

qs('#backToDecks').addEventListener('click', (e)=>{ e.preventDefault(); renderDecks(); });

function updateGlobalProgress(){
  const own = new Set(load());
  qs('#progress').textContent = `${own.size} / ${ALL_CARDS.length} Karten gesammelt`;
}

/***********************
 * RENDER GRID (Deck)  *
 ***********************/
function renderGrid(deckId){
  const deck = DECKS.find(d=>d.id===deckId);
  const own = new Set(load());
  const grid = qs('#grid');
  grid.innerHTML = '';
  deck.cards.forEach(card => {
    const slot = el('div','slot' + (own.has(card.id)?'':' locked'));

    if(own.has(card.id)){
      const cardEl = makeCard(card);
      enableTilt(cardEl);
      cardEl.title = 'Klicke zum Anzeigen';
      cardEl.addEventListener('click', ()=> viewCard(card));
      slot.appendChild(cardEl);
    } else {
      const lock = el('div','shine');
      const silhouette = el('div');
      silhouette.style.width='60%'; silhouette.style.height='60%'; silhouette.style.borderRadius='14px';
      silhouette.style.border='1px dashed #314081'; silhouette.style.background='linear-gradient(180deg,#0c1333,#0a0f26)';
      slot.appendChild(silhouette); slot.appendChild(lock);
    }
    grid.appendChild(slot);
  });
  updateGlobalProgress();
}

function makeCard(card){
  const cardEl = el('div','card');
  const inner = el('div','inner' + (card.special?' holo':''));
  const name = el('div','name'); name.textContent = card.name;
  const ill = el('div','illus');
  if(card.img){ const img=document.createElement('img'); img.src=card.img; img.alt=card.name; ill.appendChild(img); }
  const meta = el('div','meta'); meta.innerHTML = `<span>${card.special? 'Special ‚Ä¢ Holo' : 'Standard'}</span><span>${card.id.toUpperCase()}</span>`;
  inner.append(name, ill, meta); cardEl.appendChild(inner);
  return cardEl;
}

/***********************
 * OVERLAY & INTERAKTION
 ***********************/
function viewCard(card){
  const overlay = qs('#overlay');
  overlay.classList.add('active');
  setupFlyCard(card);
}

function setupFlyCard(card){
  const fly = qs('#flyCard');
  const inner = qs('#flyInner');
  const illus = qs('#flyIllus');
  inner.classList.toggle('holo', !!card.special);
  qs('#flyName').textContent = card.name;
  qs('#flyMeta').textContent = card.special? 'Special ‚Ä¢ Holo' : 'Standard';
  qs('#flyId').textContent = card.id.toUpperCase();
  illus.innerHTML = '';
  const img = document.createElement('img'); img.src = card.img; img.alt = card.name; img.style.maxWidth='100%'; img.style.maxHeight='100%'; img.style.borderRadius='10px';
  illus.appendChild(img);
  fly.style.opacity = 1; fly.style.transform='translateY(0) scale(1)';
  enableSpinAndDrag(fly);
}

function enableTilt(node){
  let rect, active=false;
  const update = (x,y)=>{
    const cx = rect.left + rect.width/2; const cy = rect.top + rect.height/2;
    const dx = (x - cx) / (rect.width/2); const dy = (y - cy) / (rect.height/2);
    const rx = (+dy * 8).toFixed(2); const ry = (-dx * 10).toFixed(2);
    node.style.transform = `perspective(900px) rotateX(${rx}deg) rotateY(${ry}deg)`;
    node.style.boxShadow = `0 ${12 - dy*8}px ${36 + Math.abs(dx*12)}px rgba(0,0,0,.35)`;
  };
  const reset = ()=>{ node.style.transform=''; node.style.boxShadow=''; active=false };
  node.addEventListener('pointerenter', e=>{rect=node.getBoundingClientRect(); active=true});
  node.addEventListener('pointermove', e=>{ if(!active){rect=node.getBoundingClientRect(); active=true} update(e.clientX, e.clientY) });
  node.addEventListener('pointerleave', reset);
  node.addEventListener('pointerdown', e=>{ node.setPointerCapture(e.pointerId); rect=node.getBoundingClientRect(); active=true });
  node.addEventListener('pointerup', reset);
}

// Linksklick drehen, Shift+Drag verschieben, Wheel/Pinch zoomen
function enableSpinAndDrag(node){
  let isDown=false, lastX=0, lastY=0;
  let rotX=0, rotY=0, tx=0, ty=0, scale=1;
  let vx=0, vy=0, vrx=0, vry=0, vs=0, raf;
  const maxTilt=45, minScale=0.6, maxScale=1.8;
  let pointers=new Map();
  const clampScale=()=>{ scale = Math.max(minScale, Math.min(maxScale, scale)) };
  const apply=()=>{ node.style.transform = `translate(${tx}px, ${ty}px) perspective(1000px) rotateX(${rotX}deg) rotateY(${rotY}deg) scale(${scale})` };
  const inertia=()=>{ vx*=0.92; vy*=0.92; vrx*=0.92; vry*=0.92; vs*=0.85; tx+=vx; ty+=vy; rotX+=vry; rotY+=vrx; scale+=vs; clampScale(); apply(); if(Math.abs(vx)+Math.abs(vy)+Math.abs(vrx)+Math.abs(vry)+Math.abs(vs) > 0.06){ raf=requestAnimationFrame(inertia) } };

  function pinchDist(){ const arr=[...pointers.values()]; if(arr.length<2) return 0; const dx=arr[0].x-arr[1].x, dy=arr[0].y-arr[1].y; return Math.hypot(dx,dy) }
  let baseDist=0, baseScale=1;

  node.onpointerdown = (e)=>{ isDown=true; node.setPointerCapture(e.pointerId); lastX=e.clientX; lastY=e.clientY; if(raf) cancelAnimationFrame(raf); pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}); if(pointers.size===2){ baseDist=pinchDist(); baseScale=scale } };
  node.onpointermove = (e)=>{
    pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
    if(pointers.size>=2){ const d=pinchDist(); if(baseDist>0){ const factor=d/baseDist; scale = baseScale * factor; clampScale(); apply(); } return; }
    if(!isDown) return; const dx=e.clientX-lastX, dy=e.clientY-lastY; lastX=e.clientX; lastY=e.clientY;
    // Default: drehen
    rotY += dx*0.35; rotX -= dy*0.35; rotX=Math.max(-maxTilt, Math.min(maxTilt, rotX)); vry = -dy*0.35; vrx = dx*0.35;
    // Shift: verschieben
    if(e.shiftKey){ rotY -= dx*0.35; rotX += dy*0.35; vry=vrx=0; tx+=dx; ty+=dy; vx=dx; vy=dy; }
    apply();
  };
  node.onpointerup = (e)=>{ isDown=false; pointers.delete(e.pointerId); if(pointers.size<2){ raf=requestAnimationFrame(inertia) } };
  node.onpointercancel = (e)=>{ pointers.delete(e.pointerId) };
  node.onwheel = (e)=>{ e.preventDefault(); const delta = -Math.sign(e.deltaY) * (Math.abs(e.deltaY)>40? 0.08:0.04); scale += delta; clampScale(); vs=delta; apply(); };
  node.ondblclick = ()=>{ rotX=rotY=tx=ty=0; scale=1; apply(); };
}

/***********************
 * UNLOCK FLOW (QR)    *
 ***********************/
function unlockByCode(code){
  if(!code) return false;
  const card = ALL_CARDS.find(c => c.code && c.code.toUpperCase() === String(code).toUpperCase());
  if(!card){ toast('Ung√ºltiger Code'); return false }
  const own = new Set(load());
  const deckId = card.deckId;
  const wasComplete = isDeckComplete(deckId, own);

  if(own.has(card.id)){
    toast('Diese Karte hast du bereits.'); setupFlyCard(card); openOverlayFX();
    if(CURRENT_DECK!==deckId) openDeck(deckId);
    return true
  }
  own.add(card.id); save([...own]);
  if(CURRENT_DECK!==deckId) openDeck(deckId); else renderGrid(CURRENT_DECK);
  playLootbox(card);

  // Check completion after adding
  const nowComplete = isDeckComplete(deckId, own);
  if(!wasComplete && nowComplete){
    const deck = DECKS.find(d=>d.id===deckId);
    if(deck && deck.coverImg) showCoverUnlocked(deck);
  }
  return true;
}

/***********************
 * LOOTBOX (wie vorher, deck-agnostisch)
 ***********************/
function openOverlayFX(){ qs('#overlay').classList.add('active') }

function playLootbox(card){
  const overlay = qs('#overlay'); const lid = qs('#lid'); const fly = qs('#flyCard'); const chest=qs('#chest'); const rays=qs('#rays'); const flash=qs('#flash');
  overlay.classList.add('active');
  setupFlyCard(card);
  rays.style.opacity=0; flash.style.opacity=0; fly.style.opacity=0; fly.style.transform='translateY(30px) scale(.92) rotate(0deg)'; chest.classList.remove('glow');
  chest.animate([{ transform:'translateY(0)' },{ transform:'translateY(-6px)' },{ transform:'translateY(0)' }], { duration: 420, easing:'ease-out' });
  lid.animate([{ transform: 'rotateX(0deg)' }, { transform: 'rotateX(-112deg)' }], { duration: 680, easing:'cubic-bezier(.2,.8,.2,1)', fill:'forwards' });
  setTimeout(()=>{ rays.animate([{ opacity:0, transform:'scale(.8) rotate(0deg)' }, { opacity:1, transform:'scale(1) rotate(120deg)' }], { duration:500, easing:'ease-out', fill:'forwards' }); flash.animate([{ opacity:0 }, { opacity:1 }, { opacity:0 }], { duration:420, easing:'ease-out' }); chest.classList.add('glow'); }, 420);
  setTimeout(()=>{ fly.style.opacity=1; const anim = fly.animate([{ transform:'translateY(30px) scale(.92) rotate(-4deg)' },{ transform:'translateY(-140px) scale(1) rotate(0deg)' }], { duration: 880, easing:'cubic-bezier(.2,.8,.2,1)', fill:'forwards' }); anim.onfinish = ()=> { burstConfetti(160); haloRing(); glowPulse(fly) } }, 520);
}
function glowPulse(node){ node.animate([{ boxShadow:'0 0 0px rgba(124,243,214,0.0)' },{ boxShadow:'0 0 60px rgba(124,243,214,0.55)' },{ boxShadow:'0 0 0px rgba(124,243,214,0.0)' }], { duration: 1000, easing:'ease-in-out' }); }
function burstConfetti(n=120){ for(let i=0;i<n;i++){ const p = el('div'); const size = 6 + Math.random()*6; p.style.width=p.style.height=size+"px"; p.style.position='fixed'; p.style.left=(Math.random()*100)+"%"; p.style.top='-10px'; p.style.background = `hsl(${Math.random()*360}, 85%, 65%)`; p.style.borderRadius = Math.random()>.5? '2px':'50%'; p.style.pointerEvents='none'; p.style.zIndex=60; p.style.filter='drop-shadow(0 2px 6px rgba(0,0,0,.35))'; document.body.appendChild(p); const dx = (Math.random()-.5)*160; const dur= 1500 + Math.random()*1200; p.animate([{ transform:`translate(0, 0) rotate(0deg)`, opacity:1 },{ transform:`translate(${dx}px, 100vh) rotate(${Math.random()*600-300}deg)`, opacity:.9 }], { duration: dur, easing:'cubic-bezier(.2,.8,.2,1)' }).onfinish = ()=> p.remove(); } }
function haloRing(){ const ring = el('div'); ring.style.position='absolute'; ring.style.width='20px'; ring.style.height='20px'; ring.style.border='2px solid rgba(124,243,214,.8)'; ring.style.borderRadius='50%'; ring.style.top='50%'; ring.style.left='50%'; ring.style.transform='translate(-50%,-50%)'; ring.style.opacity='0.9'; ring.style.filter='blur(0.6px)'; ring.style.zIndex=55; qs('.stage').appendChild(ring); ring.animate([{ transform:'translate(-50%,-50%) scale(.6)', opacity:.9 }, { transform:'translate(-50%,-50%) scale(6)', opacity:0 }], { duration: 900, easing:'ease-out' }).onfinish = ()=> ring.remove(); }

/***********************
 * CAMERA QR (optional)
 ***********************/
async function scanCamera(){
  const overlay = qs('#overlay');
  const stage = overlay.querySelector('.stage');

  // Clean previous video if any
  stage.querySelectorAll('video').forEach(v=>{ try{v.srcObject?.getTracks().forEach(t=>t.stop())}catch{} v.remove(); });

  // Feature detection
  const supportsBarcode = ('BarcodeDetector' in window);
  const supportsMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);

  if(!supportsMedia){
    toast('Keine Kamera verf√ºgbar ‚Äì manueller Code-Eingabemodus.');
    openManualModal();
    return;
  }

  overlay.classList.add('active');

  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'} }, audio:false });
    const video = document.createElement('video');
    video.playsInline = true; video.setAttribute('playsinline','');
    video.muted = true; video.autoplay = true; video.style.maxWidth='92vw'; video.style.maxHeight='70vh'; video.style.border='1px solid #223169'; video.style.borderRadius='12px';
    video.srcObject = stream; stage.appendChild(video);
    try{ await video.play(); }catch(_){}

    let stop=false;

    if(supportsBarcode){
      const detector = new BarcodeDetector({ formats:['qr_code'] });
      toast('Kamera ge√∂ffnet‚Ä¶ Richte den QR-Code ins Bild.');
      async function tick(){
        if(stop) return; requestAnimationFrame(tick);
        if(video.readyState >= 2){
          try{
            const codes = await detector.detect(video);
            if(codes && codes[0]){
              stop = true;
              stream.getTracks().forEach(t=>t.stop());
              video.remove();
              let codeVal = codes[0].rawValue;
              try{ const u = new URL(codeVal); codeVal = u.searchParams.get('unlock') || codeVal; }catch{}
              unlockByCode(codeVal);
            }
          }catch(err){ /* detector may throw sporadically; ignore frame */ }
        }
      }
      tick();

      // Close handler cleans up
      qs('#closeOverlay').onclick = ()=>{ stop=true; try{stream.getTracks().forEach(t=>t.stop())}catch{} video.remove(); overlay.classList.remove('active'); };
      return;
    }

    // If no BarcodeDetector ‚Üí show manual modal while camera stream is active
    toast('QR-Scanning nicht unterst√ºtzt ‚Äì bitte Code manuell eingeben.');
    openManualModal();
    // Close should also stop camera
    qs('#closeOverlay').onclick = ()=>{ try{stream.getTracks().forEach(t=>t.stop())}catch{} video.remove(); overlay.classList.remove('active'); };
  }catch(err){
    console.warn('scanCamera error:', err);
    toast('Kamera-Zugriff abgelehnt oder fehlgeschlagen.');
    overlay.classList.remove('active');
    openManualModal();
  }
}

function openManualModal(){
  const m = qs('#manualScanModal');
  m.style.display = 'grid';
  const input = qs('#manualCodeInput');
  setTimeout(()=> input && input.focus(), 50);
}

qs('#closeManualModal').addEventListener('click', ()=>{ qs('#manualScanModal').style.display='none'; });
qs('#manualSubmitBtn').addEventListener('click', ()=>{
  const raw = qs('#manualCodeInput').value.trim();
  if(!raw){ toast('Bitte Code eingeben'); return }
  let val = raw;
  try{ const u = new URL(raw); val = u.searchParams.get('unlock') || raw; }catch{}
  qs('#manualScanModal').style.display='none';
  unlockByCode(val);
});

/***********************
 * SHARE & BOOTSTRAP   *
 ***********************/
function copyUnlockLink(){
  const owned = new Set(load());
  const pool = CURRENT_DECK ? DECKS.find(d=>d.id===CURRENT_DECK).cards : ALL_CARDS;
  const next = pool.find(c=>!owned.has(c.id));
  if(!next){ toast('Du hast bereits alle Karten in diesem Bereich!'); return }
  const url = new URL(location.href);
  url.searchParams.set('unlock', next.code);
  navigator.clipboard.writeText(url.toString()).then(()=> toast(`Link kopiert f√ºr: ${next.name}`))
}

// --- Einfache Debug-Tests (brechen nichts in der UI) ---
(function runSmokeTests(){
  try{
    console.assert(Array.isArray(DECKS) && DECKS.length===3, 'DECKS sollte 3 Decks enthalten');
    const total = DECKS.reduce((s,d)=>s+d.cards.length,0);
    console.assert(ALL_CARDS.length===total, 'ALL_CARDS L√§nge stimmt');
    const byCode = code => ALL_CARDS.find(c=> (c.code||'').toUpperCase()===(code||'').toUpperCase());
    console.assert(byCode('1501')?.deckId==='season1', 'Code 1501 ‚Üí season1');
    console.assert(byCode('HOLO2')?.deckId==='mystery', 'Code HOLO2 ‚Üí mystery');
    console.assert(byCode('S2-10')?.deckId==='season2', 'Code S2-10 ‚Üí season2');
    console.log('[Tests] alle Smoke-Tests bestanden');
  }catch(e){ console.warn('[Tests] Fehler', e); }
})();

// Boot
renderDecks();
qs('#resetBtn').addEventListener('click', ()=>{ localStorage.removeItem(STORAGE_KEY); renderDecks(); toast('Sammlung zur√ºckgesetzt') });
qs('#shareBtn').addEventListener('click', copyUnlockLink);
qs('#scanBtn').addEventListener('click', scanCamera);
qs('#closeOverlay').addEventListener('click', ()=>{ qs('#overlay').classList.remove('active'); });

// URL unlock
const params = new URLSearchParams(location.search);
const unlockParam = params.get('unlock');
if(unlockParam){ setTimeout(()=> unlockByCode(unlockParam), 200) }
</script>
  <script>
  // Helpers for deck completion & modal (appended)
  function isDeckComplete(deckId, ownSet){
    const deck = DECKS.find(d=>d.id===deckId);
    if(!deck) return false;
    return deck.cards.every(function(c){ return ownSet.has(c.id); });
  }
  function showCoverUnlocked(deck){
  var m = document.querySelector('#coverModal');
  var img = document.querySelector('#coverPreview');
  var src = (COVER_SRC[deck.id] || deck.coverImg || '');
  // Falls coverImg ohne Endung ist und nichts aufgel√∂st wurde ‚Üí .jpg anf√ºgen
  if(src && src.indexOf('.') === -1){ src = src + '.jpg'; }
  img.src = src; img.alt = (deck.name || 'Deck') + ' cover';
  m.classList.add('active');
}
  document.querySelector('#closeCoverModal').addEventListener('click', function(){ document.querySelector('#coverModal').classList.remove('active'); });
  </script>
</body>
</html>

